{"cells":[{"cell_type":"code","source":["from google.colab import drive\n","drive.mount('/content/drive')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"d26Dev01hv9e","executionInfo":{"status":"ok","timestamp":1765543202812,"user_tz":0,"elapsed":1594,"user":{"displayName":"Udaya Bhandarkar","userId":"00897349234005641073"}},"outputId":"268d43be-766a-4621-e2db-d9dcb0630962"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(\"/content/drive\", force_remount=True).\n"]}]},{"cell_type":"code","source":["import os\n","import re\n","import pandas as pd"],"outputs":[],"execution_count":null,"metadata":{"id":"zZhtpxrjhgsv"}},{"cell_type":"code","source":["EXCEL_FILE = '/content/drive/MyDrive/Tesla Financial Statement Analysis/Financial_statement_analysis_Tesla.xlsx'\n","OUTPUT_CSV = 'Tesla_Financials_Tableau_Ready.csv'"],"metadata":{"id":"71uwytpkhq4W"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def detect_sheet_names(xl):\n","    bs_name = None\n","    is_name = None\n","    for name in xl.sheet_names:\n","        lower = name.lower()\n","        if 'balance' in lower and bs_name is None:\n","            bs_name = name\n","        if ('income' in lower or 'profit' in lower) and is_name is None:\n","            is_name = name\n","    return bs_name, is_name"],"metadata":{"id":"0lRJKb4wi7yM"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def read_sheet_try_headers(xl, sheet_name):\n","    try:\n","        df = pd.read_excel(xl, sheet_name=sheet_name, header=2, engine='openpyxl')\n","        # If the dataframe is empty or looks wrong, fallback\n","        if df.shape[1] < 2 or df.dropna(how='all').shape[0] == 0:\n","            raise ValueError(\"Header=2 read looks empty or invalid, fallback to header=0\")\n","        return df\n","    except Exception:\n","        # fallback\n","        df = pd.read_excel(xl, sheet_name=sheet_name, header=0, engine='openpyxl')\n","        return df"],"metadata":{"id":"8PuliG1fjQk8"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def clean_and_reshape(df):\n","    df = df.copy()\n","\n","    # If first column is an unnamed index or empty, drop it\n","    if df.columns[0].startswith('Unnamed') or df.iloc[:,0].isnull().all():\n","        df = df.drop(df.columns[0], axis=1)\n","\n","    # Rename first column to Metric\n","    df.rename(columns={df.columns[0]: 'Metric'}, inplace=True)\n","\n","    # Drop rows where Metric is null\n","    df = df.dropna(subset=['Metric'])\n","\n","    # Identify year columns strictly as 4-digit year names\n","    year_cols = [c for c in df.columns if re.match(r'^\\s*\\d{4}\\s*$', str(c))]\n","    if not year_cols:\n","        # If none found, attempt to find numeric-like columns (fallback)\n","        year_cols = [c for c in df.columns if str(c).strip().isdigit()]\n","\n","    # If still none, raise so user knows the sheet structure is unexpected\n","    if not year_cols:\n","        raise ValueError(\"No year columns detected. Column names were: \" + \", \".join(map(str, df.columns.tolist())))\n","\n","    # Melt\n","    df_melted = df.melt(id_vars=['Metric'], value_vars=year_cols, var_name='Year', value_name='Value')\n","\n","    # Clean Value: remove commas, parentheses (for negatives), spaces; handle parentheses as negatives\n","    def parse_value(v):\n","        if pd.isna(v):\n","            return float('nan')\n","        s = str(v).strip()\n","        # handle parentheses for negatives: (1,234) -> -1234\n","        if re.match(r'^\\(.*\\)$', s):\n","            s = '-' + s.strip('()')\n","        # remove commas and spaces\n","        s = s.replace(',', '').replace(' ', '')\n","        # if empty after cleaning -> NaN\n","        if s in ['', '-']:\n","            return float('nan')\n","        try:\n","            return float(s)\n","        except Exception:\n","            return float('nan')\n","\n","    df_melted['Value'] = df_melted['Value'].apply(parse_value).fillna(0)\n","\n","    # Clean Metric and Year\n","    df_melted['Metric'] = df_melted['Metric'].astype(str).str.strip()\n","    df_melted['Year'] = df_melted['Year'].astype(str).str.strip()\n","\n","    return df_melted"],"metadata":{"id":"-FepszcwjhLd"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def categorize(metric):\n","    metric = metric.lower()\n","    if 'kpi' in metric or metric.startswith('kpi:'):\n","        return 'Key Ratios'\n","    if 'margin' in metric:\n","        return 'Profitability'\n","    if 'asset' in metric or 'cash' in metric or 'inventory' in metric or 'liabilities' in metric:\n","        return 'Balance Sheet'\n","    if 'revenue' in metric or 'cost' in metric or 'income' in metric:\n","        return 'Income Statement'\n","    return 'Other'"],"metadata":{"id":"klUGcQMNkboB"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["def main():\n","    if not os.path.exists(EXCEL_FILE):\n","        raise FileNotFoundError(f\"Could not find file: {EXCEL_FILE}\")\n","\n","    xl = pd.ExcelFile(EXCEL_FILE, engine='openpyxl')\n","    bs_sheet, is_sheet = detect_sheet_names(xl)\n","\n","    # Fallback: if names not detected, try typical sheet order or ask user (we will assume first two sheets)\n","    if not bs_sheet or not is_sheet:\n","        sheet_list = xl.sheet_names\n","        if len(sheet_list) >= 2:\n","            # attempt: assume first is balance, second is income (common exported layout)\n","            if not bs_sheet:\n","                bs_sheet = sheet_list[0]\n","            if not is_sheet:\n","                is_sheet = sheet_list[1]\n","        else:\n","            raise ValueError(\"Unable to detect Balance Sheet and Income Statement sheets automatically. Found sheets: \" + \", \".join(sheet_list))\n","\n","    # Read sheets with header fallback\n","    bs_raw = read_sheet_try_headers(xl, bs_sheet)\n","    is_raw = read_sheet_try_headers(xl, is_sheet)\n","\n","    # Process\n","    bs_long = clean_and_reshape(bs_raw)\n","    is_long = clean_and_reshape(is_raw)\n","\n","    # Combine and pivot\n","    full_data = pd.concat([bs_long, is_long], ignore_index=True)\n","    df_wide = full_data.pivot_table(index='Year', columns='Metric', values='Value', aggfunc='sum').reset_index()\n","\n","    # Compute KPIs (safe .get with default)\n","    # Profitability\n","    df_wide['KPI: Gross Margin %'] = df_wide.get('Gross profit', 0) / df_wide.get('Total revenues', 1)\n","    df_wide['KPI: Operating Margin %'] = df_wide.get('EBIT', 0) / df_wide.get('Total revenues', 1)\n","    df_wide['KPI: Net Margin %'] = df_wide.get('Net income (loss) attributable to common stockholders', 0) / df_wide.get('Total revenues', 1)\n","\n","    # Liquidity\n","    df_wide['KPI: Current Ratio'] = df_wide.get('Total current assets', 0) / df_wide.get('Total current liabilities', 1)\n","    df_wide['KPI: Quick Ratio'] = (df_wide.get('Total current assets', 0) - df_wide.get('Inventory', 0)) / df_wide.get('Total current liabilities', 1)\n","\n","    # Leverage\n","    df_wide['KPI: Debt-to-Equity'] = df_wide.get('Total liabilities', 0) / df_wide.get(\"Total stockholders' equity\", 1)\n","\n","    # Efficiency\n","    df_wide['KPI: Inventory Turnover'] = df_wide.get('Total cost of revenues', 0).abs() / df_wide.get('Inventory', 1)\n","    df_wide['KPI: Asset Turnover'] = df_wide.get('Total revenues', 0) / df_wide.get('Total assets', 1)\n","\n","    # Melt back to long for Tableau\n","    final_tableau_dataset = df_wide.melt(id_vars=['Year'], var_name='Metric Name', value_name='Value')\n","    final_tableau_dataset['Category'] = final_tableau_dataset['Metric Name'].apply(categorize)\n","\n","    # Sorting\n","    final_tableau_dataset = final_tableau_dataset.sort_values(by=['Year', 'Category', 'Metric Name']).reset_index(drop=True)\n","\n","    # Save\n","    OUTPUT_CSV = os.path.join(os.path.dirname(EXCEL_FILE), 'Tesla_Financials_Tableau_Ready.csv')\n","    final_tableau_dataset.to_csv(OUTPUT_CSV, index=False)\n","    print(f\"Success: wrote {OUTPUT_CSV}. Detected sheets - Balance: {bs_sheet}, Income: {is_sheet}\")\n","\n","if __name__ == '__main__':\n","    main()"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"LbDW3bynkvZ5","executionInfo":{"status":"ok","timestamp":1765543484411,"user_tz":0,"elapsed":75,"user":{"displayName":"Udaya Bhandarkar","userId":"00897349234005641073"}},"outputId":"c366f7bb-66d3-4786-b222-cc843585e3b8"},"execution_count":30,"outputs":[{"output_type":"stream","name":"stdout","text":["Success: wrote /content/drive/MyDrive/Tesla Financial Statement Analysis/Tesla_Financials_Tableau_Ready.csv. Detected sheets - Balance: Balance Sheet, Income: Income Statement\n"]}]}],"metadata":{"colab":{"provenance":[]},"kernelspec":{"display_name":"Python 3","name":"python3"}},"nbformat":4,"nbformat_minor":0}